<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reliance Jio Infotech Solutions - AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        .chat-container {
            height: calc(100vh - 120px);
        }
        .message-bubble {
            max-width: 80%;
            word-wrap: break-word;
        }
        .typing-indicator {
            display: none;
        }
        .typing-indicator.show {
            display: flex;
        }
        .file-upload-area {
            border: 2px dashed #3b82f6;
            transition: all 0.3s ease;
        }
        .file-upload-area:hover {
            border-color: #1d4ed8;
            background-color: #eff6ff;
        }
        .form-input {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.3s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .download-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
            border: 2px solid #059669;
            font-weight: 600;
        }
        .download-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        .mode-btn {
            transition: all 0.3s ease;
        }
        .mode-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .mode-btn:hover {
            transform: translateY(-1px);
        }
        .summary-content {
            background: #f8fafc;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 0.5rem 0;
        }
        .table-preview {
            overflow-x: auto;
            background: white;
            border-radius: 0.375rem;
            margin: 0.5rem 0;
        }
        .table-preview table {
            width: 100%;
            border-collapse: collapse;
        }
        .table-preview th,
        .table-preview td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: left;
        }
        .table-preview th {
            background-color: #f3f4f6;
            font-weight: 600;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Reliance Jio Infotech Solutions</h1>
                        <p class="text-blue-100 text-sm">Advanced AI-Powered Document Processing</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="qaMode" class="mode-btn active px-4 py-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition-all">
                        <i class="fas fa-comments mr-2"></i>HR Q&A Chat
                    </button>
                    <button id="summarizeMode" class="mode-btn px-4 py-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition-all">
                        <i class="fas fa-file-pdf mr-2"></i>PDF Summarization
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Chat Container -->
    <div class="container mx-auto px-4 py-4">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- Chat Messages Area -->
            <div id="chatMessages" class="chat-container overflow-y-auto p-4 space-y-4">
                <!-- Welcome Message -->
                <div class="flex justify-start">
                    <div class="message-bubble bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center space-x-2 mb-2">
                            <i class="fas fa-robot text-blue-600"></i>
                            <span class="font-semibold text-blue-800">Reliance Jio Infotech Solutions</span>
                        </div>
                        <p class="text-gray-700">
                            Welcome to Reliance Jio Infotech Solutions! I'm your intelligent companion for HR Q&A, document processing, and official document requests.
                        </p>
                        <div class="mt-3 space-y-2">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-comments text-purple-600"></i>
                                <span class="text-sm"><strong>HR Q&A Chat:</strong> Ask questions about company policies, benefits, procedures, and request official documents (type "I need a document").</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-file-pdf text-blue-600"></i>
                                <span class="text-sm"><strong>PDF Summarization:</strong> Upload large PDFs (30+ pages) with tables and get comprehensive summaries with advanced AI processing.</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-file-alt text-green-600"></i>
                                <span class="text-sm"><strong>Document Requests:</strong> Request any of 16 official document types through chat with form-based data collection.</span>
                            </div>
                        </div>
                        <div class="mt-3 p-3 bg-blue-50 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-2">üöÄ Key Features:</h4>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>‚Ä¢ HR Q&A with semantic search and AI assistance</li>
                                <li>‚Ä¢ Handles large PDFs up to 50MB with intelligent chunking</li>
                                <li>‚Ä¢ Extracts and formats table data accurately</li>
                                <li>‚Ä¢ Real-time processing with progress tracking</li>
                                <li>‚Ä¢ 16 official document types with form-based requests</li>
                                <li>‚Ä¢ Employee data validation against records</li>
                                <li>‚Ä¢ Seamless mode switching</li>
                            </ul>
                        </div>
                        <p class="text-sm text-gray-600 mt-3">
                            Use the mode buttons above or simply upload a PDF to get started!
                        </p>
                    </div>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div id="typingIndicator" class="typing-indicator p-4 border-t border-gray-200">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full pulse"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full pulse" style="animation-delay: 0.2s;"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full pulse" style="animation-delay: 0.4s;"></div>
                    </div>
                    <span class="text-sm text-gray-500">AI is thinking...</span>
                </div>
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-200 p-4">
                <!-- File Upload Area (for Summarization Mode) -->
                <div id="fileUploadArea" class="file-upload-area rounded-lg p-4 mb-4 text-center cursor-pointer">
                    <i class="fas fa-cloud-upload-alt text-3xl text-blue-600 mb-2"></i>
                    <p class="text-gray-600 mb-2">Drop your PDF here or click to browse</p>
                    <p class="text-sm text-gray-500">Supports files up to 50MB | Large documents (30+ pages) supported</p>
                    <div class="mt-2 text-xs text-gray-400">
                        <i class="fas fa-info-circle mr-1"></i>
                        Powered by advanced AI for superior accuracy
                    </div>
                    <input type="file" id="fileInput" accept=".pdf" class="hidden">
                </div>

                <!-- Dynamic Document Form (initially hidden) -->
                <div id="documentForm" class="hidden space-y-4 mb-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center space-x-2 mb-2">
                            <i class="fas fa-file-alt text-blue-600"></i>
                            <h3 class="font-semibold text-blue-800" id="documentFormTitle">Document Request Form</h3>
                        </div>
                        <p class="text-sm text-blue-700" id="documentFormDescription">Fill in the details below to generate your document.</p>
                        </div>
                    
                    <div id="documentFormFields" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Dynamic fields will be inserted here -->
                        </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <div class="flex items-center space-x-2 text-sm text-yellow-700">
                            <i class="fas fa-info-circle"></i>
                            <span>Document will be generated in official Reliance Jio Infotech Solutions format and will be available for immediate download.</span>
                        </div>
                        </div>
                     
                    <button id="generateDocument" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                        <i class="fas fa-file-alt mr-2"></i>Generate Document
                    </button>
                </div>

                <!-- Chat Input -->
                <div class="flex space-x-2">
                    <input type="text" id="messageInput" placeholder="Type your message here..." 
                           class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button id="sendMessage" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentMode = 'qa';
        let currentJobId = null;
        let statusCheckInterval = null;

        // DOM elements
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendMessage');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        const bonafideForm = document.getElementById('bonafideForm');
        const typingIndicator = document.getElementById('typingIndicator');
        const qaModeBtn = document.getElementById('qaMode');
        const summarizeModeBtn = document.getElementById('summarizeMode');

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });

            fileUploadArea.addEventListener('click', () => fileInput.click());
            fileUploadArea.addEventListener('dragover', handleDragOver);
            fileUploadArea.addEventListener('dragleave', handleDragLeave);
            fileUploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);

            qaModeBtn.addEventListener('click', () => switchMode('qa'));
            summarizeModeBtn.addEventListener('click', () => switchMode('summarize'));

            document.getElementById('generateDocument').addEventListener('click', generateDocument);

            // Initialize document form system
            initializeDocumentFormSystem();
        });

        function switchMode(mode) {
            currentMode = mode;
            
            // Update button states
            qaModeBtn.classList.toggle('active', mode === 'qa');
            summarizeModeBtn.classList.toggle('active', mode === 'summarize');
            
            // Show/hide appropriate UI elements
            fileUploadArea.classList.toggle('hidden', mode !== 'summarize');
            document.getElementById('documentForm').classList.add('hidden'); // Hide document form when switching modes
            
            // Add mode switch message
            let modeName = '';
            if (mode === 'qa') modeName = 'HR Q&A Chat';
            else if (mode === 'summarize') modeName = 'PDF Summarization';
            addMessage('user', `Switched to ${modeName} mode`);
            
            if (mode === 'qa') {
                addMessage('assistant', 'I\'m ready to help you with HR questions! üí¨\n\n‚Ä¢ Ask about company policies, benefits, and procedures\n‚Ä¢ Get information about leave policies, attendance, and more\n‚Ä¢ Request official documents (type "I need a document")\n‚Ä¢ Powered by semantic search and AI assistance\n‚Ä¢ Quick and accurate responses to your queries\n\nJust type your question and I\'ll help you find the information you need!');
            } else if (mode === 'summarize') {
                addMessage('assistant', 'I\'m ready to help you summarize PDF documents! üöÄ\n\n‚Ä¢ Upload any PDF (up to 50MB)\n‚Ä¢ Handles large documents (30+ pages)\n‚Ä¢ Extracts and formats table data\n‚Ä¢ Powered by advanced AI for superior accuracy\n\nSimply drag & drop or click to upload your PDF!');
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            fileUploadArea.classList.add('border-blue-400', 'bg-blue-50');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            fileUploadArea.classList.remove('border-blue-400', 'bg-blue-50');
        }

        function handleDrop(e) {
            e.preventDefault();
            fileUploadArea.classList.remove('border-blue-400', 'bg-blue-50');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (file.type !== 'application/pdf') {
                addMessage('assistant', '‚ùå Please select a PDF file only. I can only process PDF documents.');
                return;
            }

            if (file.size > 50 * 1024 * 1024) {
                addMessage('assistant', '‚ùå File size too large. Please select a file smaller than 50MB. For larger documents, consider splitting them into smaller parts.');
                return;
            }

            const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
            addMessage('user', `üìÑ Uploaded: ${file.name} (${fileSizeMB} MB)`);
            
            // Show processing message
            addMessage('assistant', `üîÑ Processing your PDF...\n\nüìä File: ${file.name}\nüìè Size: ${fileSizeMB} MB\n‚è±Ô∏è Estimated time: ${fileSizeMB > 10 ? '20-45 seconds' : '8-20 seconds'}\n\nPlease wait while I analyze your document with advanced AI processing...`);
            
            processPDF(file);
        }

        async function processPDF(file) {
            try {
                showTyping();
                
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/gemini/upload-gemini-async', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.statusText}`);
                }

                const result = await response.json();
                currentJobId = result.job_id;

                // Update the processing message with job ID
                const processingMessage = document.querySelector('.message-bubble:last-child');
                if (processingMessage) {
                    processingMessage.innerHTML = `üîÑ Processing your PDF...\n\nüìä File: ${file.name}\nüìè Size: ${(file.size / 1024 / 1024).toFixed(2)} MB\nüÜî Job ID: ${result.job_id}\n‚è±Ô∏è Status: Analyzing document structure...\n\nPlease wait while I process your document with advanced AI processing...`;
                }
                
                startStatusChecking();

            } catch (error) {
                hideTyping();
                addMessage('assistant', `‚ùå Sorry, I encountered an error: ${error.message}\n\nPlease try again or contact support if the issue persists.`);
            }
        }

        function startStatusChecking() {
            statusCheckInterval = setInterval(checkJobStatus, 2000);
        }

        async function checkJobStatus() {
            if (!currentJobId) return;

            try {
                const response = await fetch(`/gemini/status/${currentJobId}`);
                if (!response.ok) {
                    throw new Error('Status check failed');
                }

                const status = await response.json();

                // Update processing message with current status
                const processingMessage = document.querySelector('.message-bubble:last-child');
                if (processingMessage && status.status === 'processing') {
                    const progressBar = '‚ñà'.repeat(Math.floor(status.progress / 10)) + '‚ñë'.repeat(10 - Math.floor(status.progress / 10));
                    processingMessage.innerHTML = `üîÑ Processing your PDF...\n\nüìä File: Processing...\nüìè Progress: ${status.progress}%\n‚è±Ô∏è Status: ${status.message}\n\n${progressBar} ${status.progress}%\n\nPlease wait while I process your document...`;
                }

                if (status.status === 'completed') {
                    clearInterval(statusCheckInterval);
                    hideTyping();
                    displaySummaryResult(status.result);
                    
                    // Clean up job
                    fetch(`/gemini/cleanup/${currentJobId}`, { method: 'DELETE' });
                } else if (status.status === 'failed') {
                    clearInterval(statusCheckInterval);
                    hideTyping();
                    addMessage('assistant', `‚ùå Processing failed: ${status.error}\n\nPlease try again or contact support if the issue persists.`);
                }

            } catch (error) {
                console.error('Status check error:', error);
            }
        }

        function displaySummaryResult(result) {
            const summaryHtml = `
                <div class="summary-content">
                    <div class="mb-4">
                        <h4 class="font-semibold text-gray-800 mb-2">üìã Executive Summary</h4>
                        <p class="text-gray-700 leading-relaxed">${result.executive_summary}</p>
                    </div>
                    
                    <div class="mb-4">
                        <h4 class="font-semibold text-gray-800 mb-2">üéØ Key Points</h4>
                        <ul class="list-disc list-inside space-y-1 text-gray-700">
                            ${result.key_points.map(point => `<li>${point}</li>`).join('')}
                        </ul>
                    </div>
                    
                    ${result.tables && result.tables.length > 0 ? `
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-800 mb-2">üìä Tables Found (${result.tables.length})</h4>
                            ${result.tables.map(table => `
                                <div class="mb-3">
                                    <h5 class="font-medium text-gray-700 mb-1">Table ${table.id}: ${table.title}</h5>
                                    <p class="text-sm text-gray-600 mb-2">${table.dimensions}</p>
                                    <div class="table-preview">
                                        ${table.markdown}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            
            addMessage('assistant', summaryHtml);
        }

        async function generateBonafideCertificate() {
            const formData = {
                 employeeName: document.getElementById('employeeName').value.trim(),
                 employeeId: document.getElementById('employeeId').value.trim(),
                 designation: document.getElementById('designation').value.trim(),
                 department: document.getElementById('department').value.trim(),
                 joiningDate: document.getElementById('joiningDate').value,
                 issueDate: document.getElementById('issueDate').value
            };

            // Validate required fields
             const requiredFields = ['employeeName', 'employeeId', 'designation', 'department', 'joiningDate', 'issueDate'];
            const missingFields = requiredFields.filter(field => !formData[field]);
            
            if (missingFields.length > 0) {
                 const fieldLabels = {
                     'employeeName': 'Employee Name',
                     'employeeId': 'Employee ID', 
                     'designation': 'Designation',
                     'department': 'Department',
                     'joiningDate': 'Joining Date',
                     'issueDate': 'Issue Date'
                 };
                 const missingLabels = missingFields.map(field => fieldLabels[field]);
                 addMessage('assistant', `‚ùå Please fill in all required fields: ${missingLabels.join(', ')}`);
                 return;
             }

                         // Validate date formats
             const today = new Date();
             const issueDate = new Date(formData.issueDate);
             const joiningDate = new Date(formData.joiningDate);
             
             if (issueDate > today) {
                 addMessage('assistant', '‚ùå Issue date cannot be in the future. Please select a valid date.');
                 return;
             }
             
             if (joiningDate > today) {
                 addMessage('assistant', '‚ùå Joining date cannot be in the future. Please select a valid date.');
                return;
            }

            try {
                showTyping();
                 addMessage('user', `üìú Generating employee certificate for ${formData.employeeName} (${formData.employeeId})`);

                const response = await fetch('/certificates/generate-bonafide', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    // Try to parse error response for validation details
                    try {
                        const errorData = await response.json();
                        if (errorData.validation_result) {
                            // Handle validation errors
                            let errorMessage = '‚ùå <strong>Employee validation failed:</strong><br/><br/>';
                            
                            if (errorData.validation_result.errors && errorData.validation_result.errors.length > 0) {
                                errorMessage += '<strong>Errors:</strong><br/>';
                                errorData.validation_result.errors.forEach(error => {
                                    errorMessage += `‚Ä¢ ${error}<br/>`;
                                });
                                errorMessage += '<br/>';
                            }
                            
                            if (errorData.validation_result.warnings && errorData.validation_result.warnings.length > 0) {
                                errorMessage += '<strong>Warnings:</strong><br/>';
                                errorData.validation_result.warnings.forEach(warning => {
                                    errorMessage += `‚Ä¢ ${warning}<br/>`;
                                });
                                errorMessage += '<br/>';
                            }
                            
                            // Add suggestion to search for employees
                            errorMessage += `
                                <strong>üí° Need help finding employee details?</strong><br/>
                                ‚Ä¢ Search for employees: "search employee [name or ID]"<br/>
                                ‚Ä¢ Auto-fill form with correct data: "fill form for [name or ID]"<br/>
                                ‚Ä¢ <strong>Important:</strong> ALL fields must match exactly with our records
                            `;
                            
                            addMessage('assistant', errorMessage);
                            return;
                        } else {
                            throw new Error(errorData.message || `Certificate generation failed: ${response.statusText}`);
                        }
                    } catch (parseError) {
                    throw new Error(`Certificate generation failed: ${response.statusText}`);
                    }
                }

                 // Get the PDF blob directly
                 const pdfBlob = await response.blob();
                 const downloadUrl = URL.createObjectURL(pdfBlob);
                hideTyping();

                const certificateHtml = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center space-x-2 mb-3">
                            <i class="fas fa-certificate text-green-600 text-xl"></i>
                             <h3 class="font-semibold text-green-800">‚úÖ Employee Certificate Generated Successfully!</h3>
                        </div>
                         <div class="mb-3 space-y-1 text-sm text-green-700">
                             <p><strong>Employee:</strong> ${formData.employeeName}</p>
                             <p><strong>Employee ID:</strong> ${formData.employeeId}</p>
                             <p><strong>Designation:</strong> ${formData.designation}</p>
                             <p><strong>Department:</strong> ${formData.department}</p>
                             <p><strong>Issue Date:</strong> ${new Date(formData.issueDate).toLocaleDateString()}</p>
                        </div>
                         <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                         <button onclick="downloadCertificate('${downloadUrl}')" 
                                class="download-btn text-white px-6 py-3 rounded-lg text-sm font-medium flex items-center justify-center shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                            <i class="fas fa-download mr-2"></i>üìÑ Download Certificate
                        </button>
                         <button onclick="previewCertificate('${downloadUrl}')" 
                                class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg text-sm font-medium transition-all duration-200 flex items-center justify-center shadow-lg hover:shadow-xl transform hover:scale-105">
                            <i class="fas fa-eye mr-2"></i>üëÅÔ∏è Preview Certificate
                        </button>
                             <button onclick="generateNewCertificate()" 
                                     class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg text-sm font-medium transition-all duration-200 flex items-center justify-center shadow-lg hover:shadow-xl transform hover:scale-105">
                                 <i class="fas fa-plus mr-2"></i>üîÑ Generate Another
                        </button>
                         </div>
                         <div class="mt-3 p-3 bg-blue-50 rounded-lg">
                             <h4 class="font-semibold text-blue-800 mb-2">üèÜ Premium Certificate Features:</h4>
                             <ul class="text-sm text-blue-700 space-y-1">
                                 <li>‚Ä¢ üè¢ Professional company logo and branding</li>
                                 <li>‚Ä¢ üîê Digital signatures with security indicators</li>
                                 <li>‚Ä¢ üõ°Ô∏è Security watermarks and verification elements</li>
                                 <li>‚Ä¢ üì± QR code for instant verification</li>
                                 <li>‚Ä¢ üèÜ Certificate badge and premium design</li>
                                 <li>‚Ä¢ üìÖ DD-MM-YYYY date format (following template rules)</li>
                                 <li>‚Ä¢ üî§ Times New Roman font for body text (size 11-12)</li>
                                 <li>‚Ä¢ üé® Enhanced borders with corner decorations</li>
                                 <li>‚Ä¢ üìä Professional table formatting</li>
                                 <li>‚Ä¢ üîí ISO 27001 certified security features</li>
                                 <li>‚Ä¢ üåê Blockchain verification ready</li>
                                 <li>‚Ä¢ üìã Unique certificate ID for tracking</li>
                             </ul>
                         </div>
                    </div>
                `;
                
                addMessage('assistant', certificateHtml);

            } catch (error) {
                hideTyping();
                addMessage('assistant', `‚ùå Sorry, I encountered an error generating your certificate: ${error.message}\n\nPlease try again or contact support if the issue persists.`);
            }
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage('user', message);
            messageInput.value = '';

            // Handle different modes
            if (currentMode === 'qa') {
                // QA mode - send to chat API
                handleQAMessage(message);
            } else {
                // Enhanced response logic for other modes
            setTimeout(() => {
                    const lowerMessage = message.toLowerCase();
                    
                    if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                       addMessage('assistant', 'üëã Hello! I\'m your Reliance Jio Infotech Solutions AI Assistant, powered by advanced AI technology. I can help you with:\n\nüí¨ **HR Q&A Chat** - Ask about company policies and procedures\nüìÑ **PDF Summarization** - Upload large PDFs (30+ pages) with tables\nüìú **Document Requests** - Request official documents through chat\n\nHow can I assist you today?');
                    } else if (lowerMessage.includes('help') || lowerMessage.includes('what can you do')) {
                        addMessage('assistant', 'ü§ñ **Reliance Jio Infotech Solutions - Your Intelligent Companion**\n\nI can help you with three main services:\n\nüí¨ **HR Q&A Chat**\n‚Ä¢ Ask about company policies, benefits, and procedures\n‚Ä¢ Get information about leave policies, attendance, and more\n‚Ä¢ Request official documents (type "I need a document")\n‚Ä¢ Powered by semantic search and AI assistance\n‚Ä¢ Quick and accurate responses to your queries\n\nüìÑ **PDF Summarization**\n‚Ä¢ Upload PDFs up to 50MB\n‚Ä¢ Handles large documents (30+ pages)\n‚Ä¢ Extracts and formats table data\n‚Ä¢ Powered by advanced AI technology\n‚Ä¢ Real-time processing with progress tracking\n\nüìú **Document Requests**\n‚Ä¢ Request any of 16 official document types\n‚Ä¢ Official Reliance Jio Infotech Solutions format\n‚Ä¢ Professional document generation\n‚Ä¢ Immediate download available\n‚Ä¢ **Strict validation:** ALL fields must match exactly with employee records\n‚Ä¢ Employee data validation against records\n\nüí° **Quick Commands:**\n‚Ä¢ Type "qa" or "chat" to switch to HR Q&A mode\n‚Ä¢ Type "summarize" or "pdf" to switch to PDF mode\n‚Ä¢ Type "I need a document" to request official documents\n‚Ä¢ Search employees: "search employee [name or ID]"\n‚Ä¢ Use the mode buttons above for quick switching\n\n‚ö†Ô∏è **Important:** Document generation requires ALL employee details to match our records exactly.');
                    } else if (lowerMessage.includes('qa') || lowerMessage.includes('chat') || lowerMessage.includes('question')) {
                        switchMode('qa');
                    } else if (lowerMessage.includes('summarize') || lowerMessage.includes('pdf') || lowerMessage.includes('document')) {
                        switchMode('summarize');
                    } else if (lowerMessage.includes('thank')) {
                        addMessage('assistant', 'üôè You\'re welcome! I\'m here to help you with all your document processing and certificate generation needs. Feel free to ask if you need anything else!');
                    } else if (lowerMessage.includes('status') || lowerMessage.includes('health')) {
                        addMessage('assistant', 'üü¢ **System Status:** All services are operational\n\nüí¨ **HR Q&A Chat:** Semantic Search - Active\nüìä **PDF Processing:** Advanced AI - Active\nüìú **Document Generation:** ReportLab - Active\nüåê **API Endpoints:** All responding\n\nEverything is working perfectly! üöÄ');
                    } else if (lowerMessage.includes('search employee') || lowerMessage.includes('find employee')) {
                        const query = message.replace(/search employee|find employee/i, '').trim();
                        if (query) {
                            searchEmployees(query);
                } else {
                            addMessage('assistant', 'üîç Please provide a name or ID to search for. Example: "search employee John" or "search employee EMP0001"');
                        }
                    } else if (lowerMessage.includes('fill form for')) {
                        const employeeQuery = message.replace(/fill form for/i, '').trim();
                        if (employeeQuery) {
                            fillFormForEmployee(employeeQuery);
                        } else {
                            addMessage('assistant', 'üìù Please provide an employee name or ID. Example: "fill form for John Smith" or "fill form for EMP0001"');
                        }
                } else {
                        addMessage('assistant', `üí≠ I understand you said: "${message}"\n\nI can help you with:\nüí¨ **HR Q&A Chat** - Ask about company policies and procedures\nüìÑ **PDF Summarization** - Upload any PDF for comprehensive analysis\nüìú **Document Requests** - Request official documents through chat\n\nüí° **Quick Start:**\n‚Ä¢ Switch to HR Q&A mode to ask questions\n‚Ä¢ Upload a PDF file above for summarization\n‚Ä¢ Type "I need a document" to request official documents\n‚Ä¢ Use the mode buttons to switch between services\n‚Ä¢ Search for employees: "search employee [name or ID]"\n\n‚ö†Ô∏è **Important:** Document generation requires ALL employee details to match our records exactly.\n\nHow would you like to proceed?`);
                }
            }, 1000);
            }
        }



        function showTyping() {
            typingIndicator.classList.add('show');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTyping() {
            typingIndicator.classList.remove('show');
        }



                 function downloadCertificate(downloadUrl) {
             // Create a temporary link element
             const link = document.createElement('a');
             link.href = downloadUrl;
             link.download = 'employee_certificate.pdf';
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
             
             // Clean up the blob URL after a delay
             setTimeout(() => {
                 URL.revokeObjectURL(downloadUrl);
             }, 1000);
         }

         function previewCertificate(downloadUrl) {
             // Open PDF in new tab for preview
             window.open(downloadUrl, '_blank');
         }

                 function generateNewCertificate() {
             // Clear form fields
             document.getElementById('employeeName').value = '';
             document.getElementById('employeeId').value = '';
             document.getElementById('designation').value = '';
             document.getElementById('department').value = '';
             document.getElementById('joiningDate').value = '';
             document.getElementById('issueDate').valueAsDate = new Date();
             
             addMessage('assistant', 'üìù Form cleared! Please fill in the details for your new employee certificate.');
         }

        async function searchEmployees(query) {
            try {
                const response = await fetch(`/certificates/employee-suggestions/${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.success && data.suggestions.length > 0) {
                    let message = `üîç <strong>Found ${data.suggestions.length} employee(s):</strong><br/><br/>`;
                    
                    data.suggestions.forEach((emp, index) => {
                        message += `
                            <strong>${index + 1}. ${emp.full_name}</strong><br/>
                            <strong>ID:</strong> ${emp.employee_code}<br/>
                            <strong>Designation:</strong> ${emp.designation}<br/>
                            <strong>Department:</strong> ${emp.department}<br/>
                            <strong>Joining Date:</strong> ${emp.joining_date}<br/>
                            <br/>
                        `;
                    });
                    
                    message += `
                        <strong>üí° To generate a certificate:</strong><br/>
                        ‚Ä¢ Fill in the Employee Certificate form above with the correct details<br/>
                        ‚Ä¢ Or type: "fill form for [Employee Name or ID]"<br/>
                        ‚Ä¢ <strong>‚ö†Ô∏è Important:</strong> ALL fields must match exactly with our records
                    `;
                    
                    addMessage('assistant', message);
                } else {
                    addMessage('assistant', `üîç No employees found matching "${query}". Please try a different search term.`);
                }
            } catch (error) {
                addMessage('assistant', `‚ùå Error searching for employees: ${error.message}`);
            }
        }

        async function fillFormForEmployee(employeeQuery) {
            try {
                // First try to get employee by ID
                let response = await fetch(`/certificates/employee/${encodeURIComponent(employeeQuery)}`);
                let data = await response.json();
                
                if (!data.success) {
                    // If not found by ID, try suggestions
                    response = await fetch(`/certificates/employee-suggestions/${encodeURIComponent(employeeQuery)}`);
                    data = await response.json();
                    
                    if (data.success && data.suggestions.length > 0) {
                        // Use the first suggestion
                        const emp = data.suggestions[0];
                        fillEmployeeForm(emp);
                        return;
                    }
                } else {
                    // Found by ID
                    fillEmployeeForm(data.employee);
                    return;
                }
                
                addMessage('assistant', `‚ùå Employee "${employeeQuery}" not found. Please check the name or ID and try again.`);
            } catch (error) {
                addMessage('assistant', `‚ùå Error filling form: ${error.message}`);
            }
        }

        function fillEmployeeForm(employee) {
            document.getElementById('employeeName').value = employee.full_name;
            document.getElementById('employeeId').value = employee.employee_code;
            document.getElementById('designation').value = employee.designation;
            document.getElementById('department').value = employee.department;
            document.getElementById('joiningDate').value = employee.joining_date;
            document.getElementById('issueDate').value = new Date().toISOString().split('T')[0]; // Today's date
            
            addMessage('assistant', `‚úÖ Form filled with details for ${employee.full_name} (${employee.employee_code}). You can now generate the certificate!`);
        }

        async function handleQAMessage(message) {
            try {
                showTyping();
                
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });
                
                if (!response.ok) {
                    throw new Error(`QA API error: ${response.statusText}`);
                }
                
                const data = await response.json();
                hideTyping();
                
                if (data.response) {
                    // Check if response is a special form trigger
                    if (data.response.startsWith('SHOW_FORM:')) {
                        const parts = data.response.split(':');
                        if (parts.length === 3) {
                            const docType = parts[1];
                            const docName = parts[2];
                            showDocumentForm(docType, docName);
                            addMessage('assistant', `üìù Please fill in the details below to generate your ${docName}.`);
                        } else {
                            addMessage('assistant', data.response);
                        }
                    } else {
                        addMessage('assistant', data.response);
                    }
                } else {
                    addMessage('assistant', '‚ùå Sorry, I couldn\'t process your question. Please try again.');
                }
                
            } catch (error) {
                hideTyping();
                console.error('QA Error:', error);
                addMessage('assistant', `‚ùå Sorry, I encountered an error processing your question: ${error.message}\n\nPlease try again or contact support if the issue persists.`);
            }
        }

        // Enhanced message display with markdown support
        function addMessage(sender, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubbleClass = sender === 'user' 
                ? 'bg-blue-600 text-white' 
                : 'bg-gray-100 text-gray-800';
            
            // Convert markdown-like formatting
            const formattedContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>')
                .replace(/‚Ä¢/g, '‚Ä¢')
                .replace(/üìÑ/g, 'üìÑ')
                .replace(/üìú/g, 'üìú')
                .replace(/üöÄ/g, 'üöÄ')
                .replace(/‚úÖ/g, '‚úÖ')
                .replace(/‚ùå/g, '‚ùå')
                .replace(/üîÑ/g, 'üîÑ')
                .replace(/üìä/g, 'üìä')
                .replace(/üìè/g, 'üìè')
                .replace(/‚è±Ô∏è/g, '‚è±Ô∏è')
                .replace(/üÜî/g, 'üÜî')
                .replace(/üëã/g, 'üëã')
                .replace(/ü§ñ/g, 'ü§ñ')
                .replace(/üí°/g, 'üí°')
                .replace(/üôè/g, 'üôè')
                .replace(/üü¢/g, 'üü¢')
                .replace(/üí≠/g, 'üí≠')
                .replace(/class="[^"]*"/g, '') // Remove class attributes
                .replace(/<button[^>]*>.*?<\/button>/g, '') // Remove button elements
                .replace(/<div[^>]*class="[^"]*download-btn[^"]*"[^>]*>.*?<\/div>/g, ''); // Remove download button divs
            
            messageDiv.innerHTML = `
                <div class="message-bubble ${bubbleClass} rounded-lg p-4 max-w-xs md:max-w-md lg:max-w-lg">
                    ${formattedContent}
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Dynamic Document Form System
        let currentDocumentType = null;
        let currentDocumentName = null;

        function initializeDocumentFormSystem() {
            // Document type configurations
            window.documentTypes = {
                "1": {
                    name: "Bonafide / Employment Verification Letter",
                    fields: [
                        { id: "employeeName", label: "Employee Name *", type: "text", placeholder: "Enter full name as per records", required: true },
                        { id: "employeeId", label: "Employee ID *", type: "text", placeholder: "Enter Employee ID (e.g., EMP0001)", required: true },
                        { id: "designation", label: "Designation *", type: "text", placeholder: "e.g., Software Engineer", required: true },
                        { id: "department", label: "Department *", type: "text", placeholder: "e.g., Engineering", required: true },
                        { id: "joiningDate", label: "Joining Date *", type: "date", required: true },
                        { id: "issueDate", label: "Issue Date *", type: "date", required: true }
                    ]
                },
                "2": {
                    name: "Experience Certificate",
                    fields: [
                        { id: "employeeName", label: "Employee Name *", type: "text", placeholder: "Enter full name as per records", required: true },
                        { id: "employeeId", label: "Employee ID *", type: "text", placeholder: "Enter Employee ID", required: true },
                        { id: "designation", label: "Designation *", type: "text", placeholder: "e.g., Software Engineer", required: true },
                        { id: "department", label: "Department *", type: "text", placeholder: "e.g., Engineering", required: true },
                        { id: "joiningDate", label: "Joining Date *", type: "date", required: true },
                        { id: "relievingDate", label: "Relieving Date *", type: "date", required: true },
                        { id: "purpose", label: "Purpose", type: "text", placeholder: "e.g., Visa application, new job", required: false }
                    ]
                },
                "3": {
                    name: "Offer Letter Copy",
                    fields: [
                        { id: "employeeName", label: "Employee Name *", type: "text", placeholder: "Enter full name as per records", required: true },
                        { id: "employeeId", label: "Employee ID *", type: "text", placeholder: "Enter Employee ID", required: true },
                        { id: "designation", label: "Designation *", type: "text", placeholder: "e.g., Software Engineer", required: true },
                        { id: "department", label: "Department *", type: "text", placeholder: "e.g., Engineering", required: true },
                        { id: "joiningDate", label: "Joining Date *", type: "date", required: true }
                    ]
                },
                "4": {
                    name: "Appointment Letter Copy",
                    fields: [
                        { id: "employeeName", label: "Employee Name *", type: "text", placeholder: "Enter full name as per records", required: true },
                        { id: "employeeId", label: "Employee ID *", type: "text", placeholder: "Enter Employee ID", required: true },
                        { id: "designation", label: "Designation *", type: "text", placeholder: "e.g., Software Engineer", required: true },
                        { id: "department", label: "Department *", type: "text", placeholder: "e.g., Engineering", required: true },
                        { id: "joiningDate", label: "Joining Date *", type: "date", required: true }
                    ]
                },
                "5": {
                    name: "Promotion Letter",
                    fields: [
                        { id: "employeeName", label: "Employee Name *", type: "text", placeholder: "Enter full name as per records", required: true },
                        { id: "employeeId", label: "Employee ID *", type: "text", placeholder: "Enter Employee ID", required: true },
                        { id: "designation", label: "Designation *", type: "text", placeholder: "e.g., Software Engineer", required: true },
                        { id: "department", label: "Department *", type: "text", placeholder: "e.g., Engineering", required: true },
                        { id: "joiningDate", label: "Joining Date *", type: "date", required: true },
                        { id: "promotionDate", label: "Promotion Date *", type: "date", required: true },
                        { id: "newDesignation", label: "New Designation *", type: "text", placeholder: "e.g., Senior Software Engineer", required: true }
                    ]
                },
                "6": {
                    name: "Relieving Letter",
                    fields: [
                        { id: "employeeName", label: "Employee Name *", type: "text", placeholder: "Enter full name as per records", required: true },
                        { id: "employeeId", label: "Employee ID *", type: "text", placeholder: "Enter Employee ID", required: true },
                        { id: "designation", label: "Designation *", type: "text", placeholder: "e.g., Software Engineer", required: true },
                        { id: "department", label: "Department *", type: "text", placeholder: "e.g., Engineering", required: true },
                        { id: "joiningDate", label: "Joining Date *", type: "date", required: true },
                        { id: "relievingDate", label: "Relieving Date *", type: "date", required: true }
                    ]
                },
                "7": {
                    name: "Salary Slips",
                    fields: [
                        { id: "employeeName", label: "Employee Name *", type: "text", placeholder: "Enter full name as per records", required: true },
                        { id: "employeeId", label: "Employee ID *", type: "text", placeholder: "Enter Employee ID", required: true },
                        { id: "designation", label: "Designation *", type: "text", placeholder: "e.g., Software Engineer", required: true },
                        { id: "department", label: "Department *", type: "text", placeholder: "e.g., Engineering", required: true },
                        { id: "joiningDate", label: "Joining Date *", type: "date", required: true }
                    ]
                },
                "8": {
                    name: "Form 16 / Tax Documents",
                    fields: [
                        { id: "employeeName", label: "Employee Name *", type: "text", placeholder: "Enter full name as per records", required: true },
                        { id: "employeeId", label: "Employee ID *", type: "text", placeholder: "Enter Employee ID", required: true },
                        { id: "designation", label: "Designation *", type: "text", placeholder: "e.g., Software Engineer", required: true },
                        { id: "department", label: "Department *", type: "text", placeholder: "e.g., Engineering", required: true },
                        { id: "joiningDate", label: "Joining Date *", type: "date", required: true }
                    ]
                },
                "9": {
                    name: "Salary Certificate",
                    fields: [
                        { id: "employeeName", label: "Employee Name *", type: "text", placeholder: "Enter full name as per records", required: true },
                        { id: "employeeId", label: "Employee ID *", type: "text", placeholder: "Enter Employee ID", required: true },
                        { id: "designation", label: "Designation *", type: "text", placeholder: "e.g., Software Engineer", required: true },
                        { id: "department", label: "Department *", type: "text", placeholder: "e.g., Engineering", required: true },
                        { id: "joiningDate", label: "Joining Date *", type: "date", required: true },
                        { id: "salaryAmount", label: "Salary Amount *", type: "text", placeholder: "e.g., 75,000 per month", required: true },
                        { id: "purpose", label: "Purpose", type: "text", placeholder: "e.g., Loan application, visa", required: false }
                    ]
                },
                "10": {
                    name: "PF Statement / UAN details",
                    fields: [
                        { id: "employeeName", label: "Employee Name *", type: "text", placeholder: "Enter full name as per records", required: true },
                        { id: "employeeId", label: "Employee ID *", type: "text", placeholder: "Enter Employee ID", required: true },
                        { id: "designation", label: "Designation *", type: "text", placeholder: "e.g., Software Engineer", required: true },
                        { id: "department", label: "Department *", type: "text", placeholder: "e.g., Engineering", required: true },
                        { id: "joiningDate", label: "Joining Date *", type: "date", required: true }
                    ]
                },
                "11": {
                    name: "No Objection Certificate (NOC)",
                    fields: [
                        { id: "employeeName", label: "Employee Name *", type: "text", placeholder: "Enter full name as per records", required: true },
                        { id: "employeeId", label: "Employee ID *", type: "text", placeholder: "Enter Employee ID", required: true },
                        { id: "designation", label: "Designation *", type: "text", placeholder: "e.g., Software Engineer", required: true },
                        { id: "department", label: "Department *", type: "text", placeholder: "e.g., Engineering", required: true },
                        { id: "joiningDate", label: "Joining Date *", type: "date", required: true },
                        { id: "nocPurpose", label: "NOC Purpose *", type: "text", placeholder: "e.g., Higher studies, new job", required: true },
                        { id: "effectiveDate", label: "Effective Date *", type: "date", required: true }
                    ]
                },
                "12": {
                    name: "Non-Disclosure Agreement Copy",
                    fields: [
                        { id: "employeeName", label: "Employee Name *", type: "text", placeholder: "Enter full name as per records", required: true },
                        { id: "employeeId", label: "Employee ID *", type: "text", placeholder: "Enter Employee ID", required: true },
                        { id: "designation", label: "Designation *", type: "text", placeholder: "e.g., Software Engineer", required: true },
                        { id: "department", label: "Department *", type: "text", placeholder: "e.g., Engineering", required: true },
                        { id: "joiningDate", label: "Joining Date *", type: "date", required: true },
                        { id: "signingDate", label: "Signing Date *", type: "date", required: true }
                    ]
                },
                "13": {
                    name: "ID Card Replacement",
                    fields: [
                        { id: "employeeName", label: "Employee Name *", type: "text", placeholder: "Enter full name as per records", required: true },
                        { id: "employeeId", label: "Employee ID *", type: "text", placeholder: "Enter Employee ID", required: true },
                        { id: "designation", label: "Designation *", type: "text", placeholder: "e.g., Software Engineer", required: true },
                        { id: "department", label: "Department *", type: "text", placeholder: "e.g., Engineering", required: true },
                        { id: "joiningDate", label: "Joining Date *", type: "date", required: true },
                        { id: "reason", label: "Reason for Replacement *", type: "text", placeholder: "e.g., Lost, damaged, expired", required: true }
                    ]
                },
                "14": {
                    name: "Medical Insurance Card Copy",
                    fields: [
                        { id: "employeeName", label: "Employee Name *", type: "text", placeholder: "Enter full name as per records", required: true },
                        { id: "employeeId", label: "Employee ID *", type: "text", placeholder: "Enter Employee ID", required: true },
                        { id: "designation", label: "Designation *", type: "text", placeholder: "e.g., Software Engineer", required: true },
                        { id: "department", label: "Department *", type: "text", placeholder: "e.g., Engineering", required: true },
                        { id: "joiningDate", label: "Joining Date *", type: "date", required: true }
                    ]
                },
                "15": {
                    name: "Business Travel Authorization Letter",
                    fields: [
                        { id: "employeeName", label: "Employee Name *", type: "text", placeholder: "Enter full name as per records", required: true },
                        { id: "employeeId", label: "Employee ID *", type: "text", placeholder: "Enter Employee ID", required: true },
                        { id: "designation", label: "Designation *", type: "text", placeholder: "e.g., Software Engineer", required: true },
                        { id: "department", label: "Department *", type: "text", placeholder: "e.g., Engineering", required: true },
                        { id: "joiningDate", label: "Joining Date *", type: "date", required: true },
                        { id: "destination", label: "Destination *", type: "text", placeholder: "e.g., New York, USA", required: true },
                        { id: "purpose", label: "Purpose *", type: "text", placeholder: "e.g., Client meeting, conference", required: true },
                        { id: "duration", label: "Duration *", type: "text", placeholder: "e.g., 5 days", required: true },
                        { id: "travelDate", label: "Travel Date *", type: "date", required: true }
                    ]
                },
                "16": {
                    name: "Visa Support Letter",
                    fields: [
                        { id: "employeeName", label: "Employee Name *", type: "text", placeholder: "Enter full name as per records", required: true },
                        { id: "employeeId", label: "Employee ID *", type: "text", placeholder: "Enter Employee ID", required: true },
                        { id: "designation", label: "Designation *", type: "text", placeholder: "e.g., Software Engineer", required: true },
                        { id: "department", label: "Department *", type: "text", placeholder: "e.g., Engineering", required: true },
                        { id: "joiningDate", label: "Joining Date *", type: "date", required: true },
                        { id: "destination", label: "Destination Country *", type: "text", placeholder: "e.g., USA, UK, Canada", required: true },
                        { id: "purpose", label: "Purpose *", type: "text", placeholder: "e.g., Business trip, conference", required: true },
                        { id: "duration", label: "Duration *", type: "text", placeholder: "e.g., 2 weeks, 1 month", required: true }
                    ]
                }
            };

            // Set default dates for date fields
            const today = new Date().toISOString().split('T')[0];
            window.defaultDates = {
                issueDate: today,
                relievingDate: today,
                effectiveDate: today,
                promotionDate: today,
                signingDate: today,
                travelDate: today,
                joiningDate: today
            };
        }

        function showDocumentForm(documentType, documentName) {
            currentDocumentType = documentType;
            currentDocumentName = documentName;
            
            const docConfig = window.documentTypes[documentType];
            if (!docConfig) {
                addMessage('assistant', '‚ùå Invalid document type selected. Please try again.');
                return;
            }

            // Update form title and description
            document.getElementById('documentFormTitle').textContent = docConfig.name;
            document.getElementById('documentFormDescription').textContent = `Fill in the details below to generate your ${docConfig.name.toLowerCase()}.`;

            // Generate form fields
            const formFieldsContainer = document.getElementById('documentFormFields');
            formFieldsContainer.innerHTML = '';

            docConfig.fields.forEach(field => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'col-span-1';
                
                const label = document.createElement('label');
                label.className = 'block text-sm font-medium text-gray-700 mb-1';
                label.textContent = field.label;
                
                const input = document.createElement('input');
                input.type = field.type;
                input.id = field.id;
                input.className = 'form-input';
                input.placeholder = field.placeholder || '';
                input.required = field.required;
                
                // Set default values for date fields
                if (field.type === 'date' && window.defaultDates[field.id]) {
                    input.value = window.defaultDates[field.id];
                }
                
                fieldDiv.appendChild(label);
                fieldDiv.appendChild(input);
                formFieldsContainer.appendChild(fieldDiv);
            });

            // Show the form
            document.getElementById('documentForm').classList.remove('hidden');
            
            // Scroll to form
            document.getElementById('documentForm').scrollIntoView({ behavior: 'smooth' });
        }

        async function generateDocument() {
            try {
                const docConfig = window.documentTypes[currentDocumentType];
                if (!docConfig) {
                    addMessage('assistant', '‚ùå No document type selected. Please select a document first.');
                    return;
                }

                // Collect form data
                const formData = {};
                let hasErrors = false;
                const errors = [];

                docConfig.fields.forEach(field => {
                    const input = document.getElementById(field.id);
                    if (!input) {
                        errors.push(`Field ${field.label} not found`);
                        hasErrors = true;
                        return;
                    }

                    const value = input.value.trim();
                    if (field.required && !value) {
                        errors.push(`${field.label} is required`);
                        hasErrors = true;
                    }
                    formData[field.id] = value;
                });

                if (hasErrors) {
                    addMessage('assistant', `‚ùå Please fix the following errors:\n${errors.map(err => `‚Ä¢ ${err}`).join('\n')}`);
                    return;
                }

                // Validate employee data if employee fields are present
                if (formData.employeeId && formData.employeeName) {
                    const validationResult = await validateEmployeeData(formData);
                    if (!validationResult.isValid) {
                        addMessage('assistant', `‚ùå Employee validation failed:\n${validationResult.errors.map(err => `‚Ä¢ ${err}`).join('\n')}\n\nPlease ensure ALL fields match exactly with our records.`);
                        return;
                    }
                }

                // Submit document request
                const requestData = {
                    document_type: currentDocumentType,
                    document_name: currentDocumentName,
                    details: JSON.stringify(formData),
                    user_id: "anonymous"
                };

                const response = await fetch('/document-requests/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to submit document request');
                }

                const result = await response.json();
                
                if (result.status === 'completed') {
                    // Generate download link
                    const downloadUrl = `/document-requests/download/${result.request_id}`;
                    const downloadLink = `<a href="${downloadUrl}" class="text-blue-600 hover:text-blue-800 underline" download>üìÑ Download ${currentDocumentName}</a>`;
                    
                    addMessage('assistant', `‚úÖ **${currentDocumentName} generated successfully!**\n\n${downloadLink}\n\nüìã **Details:**\n${Object.entries(formData).map(([key, value]) => `‚Ä¢ ${key}: ${value}`).join('\n')}`);
                    
                    // Hide the form
                    document.getElementById('documentForm').classList.add('hidden');
                } else {
                    addMessage('assistant', `üìã **Document request submitted successfully!**\n\nYour request for ${currentDocumentName} has been submitted to HR.\n\nüìä **Request ID:** ${result.request_id}\nüìÖ **Submitted:** ${result.submitted_at}\n\nHR will process your request and notify you when the document is ready.`);
                    
                    // Hide the form
                    document.getElementById('documentForm').classList.add('hidden');
                }

            } catch (error) {
                console.error('Document generation error:', error);
                addMessage('assistant', `‚ùå Error generating document: ${error.message}\n\nPlease try again or contact support if the issue persists.`);
            }
        }

        async function validateEmployeeData(formData) {
            try {
                const response = await fetch('/certificates/validate-employee', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        full_name: formData.employeeName,
                        employee_code: formData.employeeId,
                        designation: formData.designation,
                        department: formData.department,
                        joining_date: formData.joiningDate
                    })
                });

                if (!response.ok) {
                    throw new Error('Validation request failed');
                }

                const result = await response.json();
                return {
                    isValid: result.is_valid,
                    errors: result.errors || [],
                    warnings: result.warnings || []
                };
            } catch (error) {
                console.error('Employee validation error:', error);
                return {
                    isValid: false,
                    errors: ['Employee validation service unavailable'],
                    warnings: []
                };
            }
        }

        // Health check on load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('/gemini/health');
                if (!response.ok) {
                    console.warn('PDF processing service health check failed');
                    addMessage('assistant', '‚ö†Ô∏è Note: PDF processing service is currently unavailable. Please try again later.');
                } else {
                    console.log('PDF processing service is healthy');
                }
            } catch (error) {
                console.warn('Cannot connect to PDF processing service');
                addMessage('assistant', '‚ö†Ô∏è Note: PDF processing service is currently unavailable. Please try again later.');
            }
        });
    </script>
</body>
</html>
